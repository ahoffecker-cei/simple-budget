<div class="expense-logging-container">
  <!-- Header -->
  <div class="header-section">
    <button mat-icon-button (click)="navigateToDashboard()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-content">
      <h1 class="page-title">Log Expense</h1>
      <p class="page-subtitle">Quick expense logging with budget impact</p>
    </div>
  </div>

  <div class="content-layout">
    <!-- Main expense entry form -->
    <mat-card class="expense-form-card">
      <mat-card-header>
        <mat-card-title>Add New Expense</mat-card-title>
        <mat-card-subtitle>Track your spending and see budget impact</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="expenseForm" (ngSubmit)="onSubmit()" class="expense-form">
          <!-- Amount Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Amount</mat-label>
            <input
              matInput
              type="number"
              id="amount-input"
              formControlName="amount"
              placeholder="0.00"
              step="0.01"
              min="0.01"
              max="999999.99">
            <span matTextPrefix>$&nbsp;</span>
            <mat-error *ngIf="expenseForm.get('amount')?.hasError('required')">
              Amount is required
            </mat-error>
            <mat-error *ngIf="expenseForm.get('amount')?.hasError('min')">
              Amount must be greater than $0.00
            </mat-error>
            <mat-error *ngIf="expenseForm.get('amount')?.hasError('max')">
              Amount cannot exceed $999,999.99
            </mat-error>
          </mat-form-field>

          <!-- Category Selection with Autocomplete -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Category</mat-label>
            <input
              type="text"
              matInput
              formControlName="categoryId"
              [matAutocomplete]="categoryAuto">
            <mat-autocomplete 
              #categoryAuto="matAutocomplete" 
              [displayWith]="getCategoryDisplayFn">
              <mat-option 
                *ngFor="let category of filteredCategories" 
                [value]="category.categoryId"
                class="category-option">
                <div class="category-option-content">
                  <span class="category-name">{{category.name}}</span>
                  <mat-chip 
                    [class]="category.isEssential ? 'essential-chip' : 'non-essential-chip'"
                    class="category-chip">
                    {{category.isEssential ? 'Essential' : 'Non-Essential'}}
                  </mat-chip>
                </div>
                <div class="category-limit">
                  Monthly Limit: {{formatCurrency(category.monthlyLimit)}}
                </div>
              </mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="expenseForm.get('categoryId')?.hasError('required')">
              Category is required
            </mat-error>
          </mat-form-field>

          <!-- Date Picker -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Date</mat-label>
            <input
              matInput
              [matDatepicker]="datePicker"
              formControlName="expenseDate"
              [max]="maxDate"
              readonly>
            <mat-datepicker-toggle matIconSuffix [for]="datePicker"></mat-datepicker-toggle>
            <mat-datepicker #datePicker></mat-datepicker>
            <mat-error *ngIf="expenseForm.get('expenseDate')?.hasError('required')">
              Date is required
            </mat-error>
          </mat-form-field>

          <!-- Optional Description -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description (Optional)</mat-label>
            <textarea
              matInput
              formControlName="description"
              placeholder="Add details about this expense..."
              rows="2"
              maxlength="500">
            </textarea>
            <mat-hint align="end">
              {{expenseForm.get('description')?.value?.length || 0}}/500
            </mat-hint>
          </mat-form-field>

          <!-- Budget Impact Preview -->
          <app-budget-impact-preview
            [categoryId]="expenseForm.get('categoryId')?.value"
            [amount]="expenseForm.get('amount')?.value || 0"
            [expenseDate]="expenseForm.get('expenseDate')?.value?.toISOString()">
          </app-budget-impact-preview>

          <!-- Duplicate Warning -->
          <div *ngIf="showDuplicateWarning" class="duplicate-warning">
            <mat-icon class="warning-icon">warning</mat-icon>
            <div class="warning-content">
              <strong>Potential duplicate detected!</strong>
              <p>Similar expenses were found recently:</p>
              <div *ngFor="let duplicate of potentialDuplicates" class="duplicate-item">
                {{formatCurrency(duplicate.amount)}} - {{duplicate.categoryName}} on {{formatDate(duplicate.expenseDate)}}
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="form-actions">
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="!expenseForm.valid || isSubmitting"
              class="submit-button">
              <mat-icon *ngIf="!isSubmitting">add</mat-icon>
              <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
              {{isSubmitting ? 'Logging...' : 'Log Expense'}}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Success Feedback Card -->
    <mat-card *ngIf="lastCreatedExpense" class="success-feedback-card">
      <mat-card-header>
        <mat-icon mat-card-avatar class="success-icon">check_circle</mat-icon>
        <mat-card-title>Expense Logged Successfully!</mat-card-title>
        <mat-card-subtitle>Budget impact calculated</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="expense-details">
          <div class="expense-amount">
            {{formatCurrency(lastCreatedExpense.expense.amount)}}
          </div>
          <div class="expense-category">
            {{lastCreatedExpense.expense.categoryName}}
            <mat-chip 
              [class]="lastCreatedExpense.expense.isEssential ? 'essential-chip' : 'non-essential-chip'"
              class="category-chip">
              {{lastCreatedExpense.expense.isEssential ? 'Essential' : 'Non-Essential'}}
            </mat-chip>
          </div>
          <div class="expense-date">
            {{formatDate(lastCreatedExpense.expense.expenseDate)}}
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="budget-impact">
          <h4>Budget Impact</h4>
          <div class="impact-details">
            <div class="impact-item">
              <span class="label">Remaining Budget:</span>
              <span class="value" [class]="getBudgetHealthColor(lastCreatedExpense.budgetHealthStatus)">
                {{formatCurrency(lastCreatedExpense.categoryRemainingBudget)}}
              </span>
            </div>
            <div class="impact-item">
              <span class="label">Health Status:</span>
              <span class="value" [class]="getBudgetHealthColor(lastCreatedExpense.budgetHealthStatus)">
                <mat-icon class="health-icon">{{getBudgetHealthIcon(lastCreatedExpense.budgetHealthStatus)}}</mat-icon>
                {{lastCreatedExpense.budgetHealthStatus | titlecase}}
              </span>
            </div>
            <div class="impact-item">
              <span class="label">Monthly Spending:</span>
              <span class="value">
                {{formatCurrency(lastCreatedExpense.categoryCurrentSpending)}} / {{formatCurrency(lastCreatedExpense.categoryMonthlyLimit)}}
              </span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Recent Expenses -->
    <mat-card *ngIf="recentExpenses.length > 0" class="recent-expenses-card">
      <mat-card-header>
        <mat-card-title>Recent Expenses</mat-card-title>
        <mat-card-subtitle>Quick fill from recent entries</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="recent-expenses-list">
          <div 
            *ngFor="let expense of recentExpenses" 
            class="recent-expense-item"
            (click)="quickFillFromRecent(expense)"
            matTooltip="Click to use as template">
            <div class="expense-info">
              <div class="amount">{{formatCurrency(expense.amount)}}</div>
              <div class="category">{{expense.categoryName}}</div>
              <div class="date">{{formatDate(expense.expenseDate)}}</div>
            </div>
            <mat-icon class="quick-fill-icon">content_copy</mat-icon>
          </div>
        </div>

        <div class="recent-expenses-actions">
          <button mat-button color="primary" (click)="viewAllExpenses()">
            View All Expenses
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
  </div>
</div>