# Story 2.1: Budget Setup Wizard - Income & Basic Info

## Status
Done

## Story
**As a** new user,
**I want** a guided wizard that collects my monthly income and basic financial information,
**so that** I can establish the foundation for my budget without feeling overwhelmed.

## Acceptance Criteria
1. Multi-step wizard with encouraging progress indicators and "you're doing great" messaging
2. Monthly income collection with validation for reasonable amounts ($1,000-$200,000 range)
3. Student loan information capture (monthly payment amount, total remaining balance)
4. Expected major monthly expenses (rent, utilities, transportation) with helpful prompting
5. Savings goal setting with encouraging guidance on emergency fund building
6. Navigation allows going back to previous steps without losing data
7. Visual design maintains reassuring, confidence-building aesthetic throughout

## Tasks / Subtasks
- [x] Backend User Profile Update Infrastructure (AC: 2, 3)
  - [x] Update User entity to include monthlyIncome, studentLoanPayment, studentLoanBalance fields
  - [x] Create Entity Framework migration for User table schema updates
  - [x] Update UsersController with PUT endpoint for profile information updates
  - [x] Add validation for income range ($1,000-$200,000) and student loan amounts
- [x] Budget Wizard API Endpoint Development (AC: 4, 5)
  - [x] Create BudgetWizardController with POST /api/v1/budget/wizard/complete endpoint
  - [x] Implement BudgetWizardRequest schema with income, student loans, and major expenses
  - [x] Add business logic for validating and calculating preliminary budget health
  - [x] Ensure sub-500ms response time requirement compliance for wizard completion
- [x] Angular Budget Wizard Component Implementation (AC: 1, 7)
  - [x] Create budget-wizard.component.ts in /apps/web/src/app/features/budget-setup/
  - [x] Implement multi-step stepper using Angular Material stepper component
  - [x] Add progress indicators with encouraging messaging ("Step 1 of 4 - You're doing great!")
  - [x] Apply confidence-building color palette and reassuring visual design
- [x] Income Collection Step Implementation (AC: 2)
  - [x] Create income-step.component.ts with form validation for monthly income
  - [x] Add input field with currency formatting and $1,000-$200,000 validation
  - [x] Include helpful prompting text and examples for income entry
  - [x] Implement real-time validation with encouraging error messages
- [x] Student Loan Information Step (AC: 3)
  - [x] Create student-loan-step.component.ts with payment and balance collection
  - [x] Add optional student loan fields with clear labeling and help text
  - [x] Include validation for reasonable student loan amounts and payments
  - [x] Add "Skip if no student loans" option with reassuring messaging
- [x] Major Expenses Collection Step (AC: 4)
  - [x] Create major-expenses-step.component.ts with common expense categories
  - [x] Pre-populate fields for rent, utilities, transportation with helpful prompts
  - [x] Add ability to customize expense categories and amounts
  - [x] Include validation to ensure major expenses don't exceed income
- [x] Savings Goals Step Implementation (AC: 5)
  - [x] Create savings-goals-step.component.ts with emergency fund guidance
  - [x] Provide encouraging guidance on emergency fund building (3-6 months expenses)
  - [x] Calculate and suggest realistic savings goals based on income and expenses
  - [x] Include positive messaging about building financial security
- [x] Navigation and Data Persistence (AC: 6)
  - [x] Implement step navigation with back/next buttons throughout wizard
  - [x] Add form state management to preserve data when navigating between steps
  - [x] Create wizard completion flow with celebratory messaging
  - [x] Integrate wizard completion with dashboard redirect and achievement display
- [x] Unit Testing Implementation
  - [x] Create BudgetWizardController unit tests using xUnit + ASP.NET Test Host
  - [x] Create budget-wizard.component.spec.ts using Jest + Angular Testing Utilities
  - [x] Test form validation, step navigation, and data persistence logic
  - [x] Test income validation ranges and student loan optional handling

## Dev Notes

### Previous Story Insights
[Source: stories/1.3.account-balance-display-dashboard.md#dev-agent-record]
- Account Balance Management Infrastructure is established with Account entities and controllers
- Dashboard display functionality with health status calculation is operational
- User authentication and JWT token management is fully functional
- Angular Material foundation is established and customized for confidence-building aesthetic
- Shared TypeScript interfaces in `/shared/src/models/` are working and integrated

### Technology Stack Details
[Source: architecture/technology-stack-table.md]
- **Frontend Framework**: Angular 15+ with TypeScript 5.0+ for multi-step wizard development
- **UI Component Library**: Angular Material 15+ with stepper component for wizard navigation
- **Backend Framework**: ASP.NET Core 8.0 with C# .NET 8 for budget wizard API endpoints
- **Database**: SQL Server LocalDB for development, Entity Framework Core for User profile updates
- **State Management**: Angular Services + RxJS for wizard step data management and persistence
- **Validation**: Angular Reactive Forms with custom validators for income and student loan amounts
- **Performance Requirement**: Sub-500ms response times for wizard data saving operations

### Data Models
[Source: architecture/user.md, architecture/budgetcategory.md]
**User Entity Updates Required:**
- MonthlyIncome: decimal - Foundation for budget calculations ($1,000-$200,000 validation range)
- StudentLoanPayment: decimal - Monthly payment amount for target demographic
- StudentLoanBalance: decimal - Total remaining debt tracking for financial health

**TypeScript Interface Updates:**
```typescript
export interface User {
  userId: string;
  email: string;
  firstName: string;
  monthlyIncome: number;
  studentLoanPayment: number;
  studentLoanBalance: number;
  createdAt: string;
  lastLoginAt: string;
}

export interface BudgetWizardRequest {
  monthlyIncome: number;
  studentLoanPayment?: number;
  studentLoanBalance?: number;
  majorExpenses: {
    rent?: number;
    utilities?: number;
    transportation?: number;
    [key: string]: number | undefined;
  };
  savingsGoal?: number;
}
```

**Database Relationships:**
[Source: architecture/user.md#relationships]
- User profile will be foundation for BudgetCategory creation in subsequent stories
- User monthly income drives budget allocation calculations

### API Specifications
[Source: architecture/rest-api-specification.md]
**Base URLs:**
- Development: https://localhost:5001/api/v1
- Production: https://simplebudget-api.azurewebsites.net/api/v1

**New Budget Wizard Endpoints:**
- `PUT /users/profile` - Update user profile with income and student loan information
- `POST /budget/wizard/complete` - Complete budget wizard flow and calculate initial budget health
- Note: Individual wizard steps should use existing RESTful endpoints (PUT /users/profile, POST /budget-categories)

**BudgetWizardRequest Schema:**
```typescript
{
  monthlyIncome: number (min: 1000, max: 200000),
  studentLoanPayment?: number (optional),
  studentLoanBalance?: number (optional),
  majorExpenses: {
    rent?: number,
    utilities?: number,
    transportation?: number
  },
  savingsGoal?: number
}
```

### Component Architecture
[Source: architecture/component-architecture.md, architecture/angular-frontend-components.md]
**Angular Component Organization:**
- Budget wizard components should be created in `/apps/web/src/app/features/budget-setup/`
- Reusable wizard step components in `/apps/web/src/app/features/budget-setup/steps/`
- Shared progress indicator component in `/apps/web/src/app/shared/components/progress-indicator/`

**Multi-Step Wizard Structure:**
```
budget-setup/
├── budget-wizard.component.ts          # Main wizard container with stepper
├── budget-wizard.component.html        # Stepper template with progress indicators
├── budget-wizard.component.scss        # Confidence-building styling
├── steps/
│   ├── income-step.component.ts        # Monthly income collection
│   ├── student-loan-step.component.ts  # Student loan information
│   ├── major-expenses-step.component.ts # Rent, utilities, transportation
│   └── savings-goals-step.component.ts  # Emergency fund guidance
└── services/
    └── budget-wizard.service.ts        # Wizard data management and API calls
```

### UI Design Requirements
[Source: prd/user-interface-design-goals.md]
**Visual Design Principles for Budget Wizard:**
- Multi-step progress indicators with encouraging messaging ("Step 2 of 4 - You're doing great!")
- Confidence-building color palette: soft greens for progress, calming blues for forms
- Clean, uncluttered design with plenty of white space to reduce cognitive load during data entry
- Reassuring messaging throughout with positive reinforcement for completing each step
- Progressive disclosure with clear explanations for each piece of financial information requested

**Wizard-Specific Requirements:**
- Back/Next navigation with clear progress preservation
- Helpful prompting text and examples for each input field
- Optional field handling with reassuring "Skip if not applicable" messaging
- Celebratory completion messaging to build user confidence in their budget foundation

### File Locations
[Source: architecture/repository-structure.md]
**Backend Files:**
- `/apps/api/Controllers/` - BudgetWizardController and UsersController updates
- `/apps/api/Models/` - User.cs entity updates for income and student loan fields
- `/apps/api/Data/` - Entity Framework migration for User table schema updates
- `/apps/api.Tests/Controllers/` - Unit tests for budget wizard and user profile controllers

**Frontend Files:**
- `/apps/web/src/app/features/budget-setup/` - Budget wizard components and services
- `/apps/web/src/app/features/budget-setup/steps/` - Individual step components
- `/apps/web/src/app/shared/components/progress-indicator/` - Reusable progress component
- `/shared/src/models/` - TypeScript interfaces for BudgetWizardRequest and User updates

**New TypeScript Model Files Needed:**
- `/shared/src/models/budget-wizard.ts` - BudgetWizardRequest and response interfaces
- Update `/shared/src/models/user.ts` - Add monthlyIncome, studentLoanPayment, studentLoanBalance
- Update `/shared/src/models/index.ts` - Export new budget wizard interfaces

### User Onboarding Workflow Integration
[Source: architecture/user-onboarding-budget-setup-workflow.md]
**Wizard Integration with Authentication:**
- Budget wizard should be accessible after successful user registration and authentication
- JWT token required for all budget wizard API calls to associate data with authenticated user
- Wizard completion should redirect to dashboard with "Budget Setup Complete!" achievement messaging

**Budget Foundation for Future Stories:**
- Income and major expenses collected in this wizard will drive BudgetCategory creation in Story 2.2
- Essential vs. non-essential classification in Story 2.3 will use major expenses as essential category seeds
- Dashboard integration in Story 2.4 will display budget health based on wizard-collected income data

### Technical Constraints
[Source: architecture/technology-stack-table.md]
- **Response Time**: Sub-500ms response times required for wizard data saving (NFR1)
- **Validation**: Income range $1,000-$200,000 with client-side and server-side validation
- **Data Persistence**: Wizard step data must persist during navigation to prevent user frustration
- **Progressive Enhancement**: Wizard must work on mobile, tablet, and desktop (NFR4)
- **Security**: All financial data protected by JWT authentication and proper input validation

### Testing
[Source: architecture/technology-stack-table.md]
**Testing Framework Requirements:**
- **Backend Testing**: xUnit + ASP.NET Test Host for API controllers and business logic
- **Frontend Testing**: Jest + Angular Testing Utilities for component testing and user interactions
- **E2E Testing**: Playwright for complete wizard flow validation

**Test File Locations:**
- Backend tests: `/apps/api.Tests/Controllers/` directory structure
- Frontend tests: Co-located with components using `.spec.ts` naming convention
- E2E tests: `/apps/web/e2e/` directory for wizard flow testing

**Budget Wizard Specific Testing Requirements:**
- **Step Navigation Testing**: Verify back/next navigation preserves form data across all steps
- **Form Validation Testing**: Test income range validation ($1,000-$200,000), student loan field validation
- **Data Persistence Testing**: Ensure wizard state persists during step navigation without data loss
- **Responsive Design Testing**: Verify wizard functionality on mobile, tablet, and desktop viewports
- **API Integration Testing**: Test wizard completion flow with budget health calculation
- **Accessibility Testing**: Ensure wizard meets WCAG 2.1 AA standards for form navigation and screen readers
- **Performance Testing**: Validate sub-500ms response times for wizard data saving operations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-11 | 1.0 | Initial story creation with comprehensive architecture context and budget wizard requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Built successfully with minor bundle size warnings
- Angular compilation resolved with correct shared model imports
- All unit tests created and framework validated

### Completion Notes List
- ✅ All backend infrastructure completed: User entity updates, migration, validation
- ✅ BudgetWizardController with budget health calculation logic implemented
- ✅ Complete multi-step Angular wizard with 4 steps: Income, Student Loans, Major Expenses, Savings Goals
- ✅ Data persistence and validation across all wizard steps
- ✅ Comprehensive unit test coverage for both backend and frontend components
- ✅ All acceptance criteria met with confidence-building UI design
- ✅ Integration ready - wizard route added and components converted to standalone architecture

### File List
**Backend Files:**
- apps/api/Models/User.cs - Updated with monthlyIncome, studentLoanPayment, studentLoanBalance fields
- apps/api/Data/Migrations/ - Database migration already exists for User profile fields
- apps/api/Controllers/UsersController.cs - Added PUT /users/profile endpoint
- apps/api/Controllers/BudgetWizardController.cs - New controller with wizard completion logic
- apps/api/DTOs/UserProfileDTOs.cs - Profile update request/response DTOs
- apps/api/DTOs/BudgetWizardDTOs.cs - Wizard request/response DTOs with budget health calculation
- apps/api.Tests/Controllers/BudgetWizardControllerTests.cs - Unit tests for wizard completion
- apps/api.Tests/Controllers/UsersControllerProfileTests.cs - Unit tests for profile updates

**Frontend Files:**
- apps/web/src/app/app.routes.ts - Added budget-wizard route
- apps/web/src/app/features/budget-setup/budget-wizard.component.ts - Main wizard container (standalone)
- apps/web/src/app/features/budget-setup/budget-wizard.component.html - Wizard stepper template
- apps/web/src/app/features/budget-setup/budget-wizard.component.scss - Confidence-building styling
- apps/web/src/app/features/budget-setup/services/budget-wizard.service.ts - Wizard state management
- apps/web/src/app/features/budget-setup/steps/income-step.component.* - Income collection step
- apps/web/src/app/features/budget-setup/steps/student-loan-step.component.* - Student loan info step
- apps/web/src/app/features/budget-setup/steps/major-expenses-step.component.* - Expense tracking step
- apps/web/src/app/features/budget-setup/steps/savings-goals-step.component.* - Savings goal setting step
- apps/web/src/app/features/budget-setup/budget-wizard.component.spec.ts - Wizard component tests
- apps/web/src/app/features/budget-setup/services/budget-wizard.service.spec.ts - Service unit tests

**Shared Files:**
- shared/src/models/budget-wizard.ts - TypeScript interfaces for wizard data
- shared/src/models/index.ts - Updated exports for budget wizard models

## QA Results
*This section will be populated by the QA agent during story review*